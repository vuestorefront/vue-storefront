---
title: Unified Data Layer
layout: default
navigation:
  icon: tabler:number-8-small
---

# Unified Data Layer

The Unified Data Layer (UDL) is a new concept introduced by Vue Storefront. This is a layer in the Vue Storefront Middleware and Storefront that allows for unification of data from different sources. The UDL provides a standardized way to interact with data, regardless of the eCommerce platform you're using. The UDL provides a structured way to manage this data, ensuring that regardless of the platform — be it Commercetools, SAPCC, or BigCommerce — the data is consistently represented. 

You can learn more about the UDL in the [Unified Data Layer](https://docs.vuestorefront.io/storefront/unified-data-layer) section of Storefront documentation.

## UDL in Vue Storefront Next.js Application

In order to help you understand Unified Data Layer better, let's add it to our Vue Storefront Next.js application. This will allow us to connect our application to different eCommerce platforms preserving the same data structure and UI components.

::info
If you don't have any other ecommerce platform installed - no worries, you can just follow this guide to have a better understanding of how UDL works.
::

## Installation and Configuration

In order to install Unified Data Model, we need to install `@vsf-enterprise/unified-api-sapcc` package. This package is a set of Unified API Extensions for SAP Commerce Cloud. 

### Configuring Vue Storefront Middleware

Go to `apps/middleware` directory and install the `@vsf-enterprise/unified-api-sapcc` package by running the following command:

```bash
npm install @vsf-enterprise/unified-api-sapcc
```

Next, we need to extend Middleware to include Unified API Extension. First, let's create `unifiedApiExtension` extension object in the `middleware.config.ts` file:

```typescript
import {
  Config,
  Context,
  createUnifiedExtension
} from "@vsf-enterprise/unified-api-sapcc";


const unifiedApiExtension = createUnifiedExtension<Context, Config>()({

});
``` 

The `unifiedApiExtension` object is the result of calling `createUnifiedExtension` function with `Context` and `Config` types as arguments. The `createUnifiedExtension` function is a factory function that accepts `normalizers`, `apiMethods` and `config` as arguments. 

The `normalizers` object is used to normalize the data from the SAP Commerce Cloud API. The `apiMethods` object is used to define the methods that will be used to interact with the SAP Commerce Cloud API. The `config` object is used to define the configuration for the SAP Commerce Cloud API.

Let's import `normalizers` and create `apiMethods` as follows: 

- Import `normalizers` and `methods` from `@vsf-enterprise/unified-api-sapcc` package.

```diff
import {
  Config,
  Context,
  createUnifiedExtension,
+ methods,
+ normalizers
} from "@vsf-enterprise/unified-api-sapcc";
```

- Create `apiMethods` object from `normalizers`.

```ts
const apiMethods = methods<typeof normalizers>();
```

Now, let's add `normalizers` and `apiMethods` to the `createUnifiedExtension` function:

```ts
const unifiedApiExtension = createUnifiedExtension<Context, Config>()({
  normalizers,
  apiMethods
});
```

### transformImageUrl

In the [Connecting Product Details Page with SAP Commerce Cloud](./7.connecting-pdp.md) guide, we used `transformImageUrl` method to transform the image URL. It's not recommended to do this in the `ProductDetails` component. Instead, we can pass the `transformImageUrl` method to the `unifiedApiExtension` object as config, so that this transformation will happen in the Middleware.

```ts
const unifiedApiExtension = createUnifiedExtension<Context, Config>()({
  normalizers,
  apiMethods,
  config: {
    transformImageUrl: (url: string) => {
      return new URL(url, process.env.SAPCC_BASE_URL).toString();
    }
  }
});
```

Since this transformation takes place in the Middleware, we can get rid of the `transformImageUrl` method from the `ProductDetails` component, as well, we can move the environment variable from the `.env.local` inside Next.js project to the `.env` file inside the Middleware project.

In the `.env` file, add the following environment variable:

```env
SAPCC_BASE_URL=[your SAP Commerce Cloud base URL]
```

Now, we need to add the `unifiedApiExtension` to the `extensions` array in the `middleware.config.ts` file:

```diff
+ import { ApiClientExtension } from "@vue-storefront/middleware";

export const integrations = {
  sapcc: {
    location: '@vsf-enterprise/sapcc-api/server',
    configuration: {
      // ...
      },
      api: {
        // ...
      }
    },
+   extensions: (extensions: ApiClientExtension[]) => [...extensions, unifiedApiExtension]
  }
};
```

The final `middleware.config.ts` file should look like this:

```ts
require('dotenv').config();
import {
  Config,
  Context,
  createUnifiedExtension,
  methods,
  normalizers
} from "@vsf-enterprise/unified-api-sapcc";
import { ApiClientExtension } from "@vue-storefront/middleware";

const apiMethods = methods<typeof normalizers>();
const unifiedApiExtension = createUnifiedExtension<Context, Config>()({
  normalizers,
  apiMethods
});

export const integrations = {
  sapcc: {
    location: '@vsf-enterprise/sapcc-api/server',
    configuration: {
      OAuth: {
        uri: process.env.SAPCC_OAUTH_URI,
        clientId: process.env.SAPCC_OAUTH_CLIENT_ID,
        clientSecret: process.env.SAPCC_OAUTH_CLIENT_SECRET,
        tokenEndpoint: process.env.SAPCC_OAUTH_TOKEN_ENDPOINT,
        tokenRevokeEndpoint: process.env.SAPCC_OAUTH_TOKEN_REVOKE_ENDPOINT,
        cookieOptions: {
          'vsf-sap-token': { secure: process.env.NODE_ENV !== 'development' }
        }
      },
      api: {
        uri: process.env.SAPCC_API_URI,
        baseSiteId: process.env.DEFAULT_BASE_SITE_ID,
        catalogId: process.env.DEFAULT_CATALOG_ID,
        catalogVersion: process.env.DEFAULT_CATALOG_VERSION,
        defaultLanguage: process.env.DEFAULT_LANGUAGE,
        defaultCurrency: process.env.DEFAULT_CURRENCY
      }
    },
    extensions: (extensions: ApiClientExtension[]) => [...extensions, unifiedApiExtension]
  }
};
```

Great! Now we have successfully installed and configured the Unified Data Layer in our Vue Storefront Middleware. Next, we need to configure Vue Storefront SDK to use the Unified Data Layer.

### Configuring Vue Storefront SDK

In order to configure Vue Storefront SDK with Unified Data Layer, we need to install `@vsf-enterprise/unified-sdk` package. This package is a set of Unified SDK Extensions for Vue Storefront.

Go to `apps/storefront` directory and install the `@vsf-enterprise/unified-sdk` package by running the following command:

```bash
npm install @vsf-enterprise/unified-sdk
```

Next, we need to build unified SDK module. Open `storefront/sdk/sdk.config.ts` file and add the following code:

```diff
- import { sapccModule } from '@vsf-enterprise/sapcc-sdk';
+ import { unifiedModule } from '@vsf-enterprise/unified-sdk';
import { CreateSdkOptions, createSdk } from "@vue-storefront/next";

export const { getSdk } = createSdk(
  options,
  ({ buildModule, middlewareUrl, getRequestHeaders }) => ({
-    sapcc: buildModule(sapccModule, {
+    unified: buildModule(unifiedModule, {
-     apiUrl: middlewareUrl + "/sapcc",
+     apiUrl: middlewareUrl + "/commerce",
      requestOptions: {
        headers: () => getRequestHeaders(),
      },
    }),
  }),
);
```

We are still missing one last thing. `unifiedModule` expects a generic type from `unifiedApiExtension` object. This is needed for SDK to automatically generate type safe methods based on Unified `apiMethods` object.

Go back to `middleware.config.ts` file and add the following line at the end of the file:

```ts
export type UnifiedApiExtension = typeof unifiedApiExtension;
```

Now, go back to `storefront/sdk/sdk.config.ts` file and add the generic type to `unifiedModule`:

```diff
export const { getSdk } = createSdk(
  options,
  ({ buildModule, middlewareUrl, getRequestHeaders }) => ({
-    unified: buildModule(unifiedModule, {
+    unified: buildModule(unifiedModule<UnifiedApiExtension>, {
      apiUrl: middlewareUrl + "/commerce",
      requestOptions: {
        headers: () => getRequestHeaders(),
      },
    }),
  }),
);
```

Great! Now we have successfully installed and configured the Unified Data Layer in our Vue Storefront SDK. Next, we need to configure Vue Storefront Next.js application to use the Unified Data Layer.

## Using Unified Data Layer in Vue Storefront Next.js Application

Unified Data Layer brings a lot of benefits to the Vue Storefront Next.js application. It allows us to use the same data structure and UI components across different eCommerce platforms. In order to use it though, your UI has to conform Unified Data Model structure. 

Let's replace the types across the application with the Unified Data Model types. For example, in the `ProductDetails` component, we can replace the `Product` type with the `SfProduct` type from the Unified Data Model:

```diff
- import { Product } from '@vue-storefront/sapcc-api';
+ import { SfProduct } from '@vsf-enterprise/unified-sdk';

interface ProductDetailsProps {
- product: Product;
+ product: SfProduct;
}
```